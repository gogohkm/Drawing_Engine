{
  "version": "1.0",
  "description": "3단계 검증 체계 규칙 정의",

  "levels": {
    "L1": {
      "name": "반환값 검증",
      "description": "MCP tool 호출 후 반환값 즉시 확인",
      "cost": "minimal",
      "when": "매 tool call 후",
      "method": "tool 반환 메시지 분석",
      "success_indicators": [
        "success 키워드 포함",
        "entity handle 반환",
        "error 없음"
      ],
      "failure_indicators": [
        "error 메시지",
        "failed 키워드",
        "null/undefined 반환"
      ]
    },
    "L2": {
      "name": "통계 검증",
      "description": "get_dxf_summary로 도면 상태 확인",
      "cost": "low",
      "when": "주요 단계 완료 시 (checkpoint)",
      "method": "get_dxf_summary 호출 후 기대값과 비교",
      "tools": ["get_dxf_summary", "get_dxf_layers", "count_by_type"]
    },
    "L3": {
      "name": "시각적 검증",
      "description": "capture_dxf_view로 렌더링 이미지 확인",
      "cost": "high",
      "when": "최종 완료 시 또는 L2 실패 시",
      "method": "capture_dxf_view 호출 후 시각적 분석",
      "tools": ["capture_dxf_view", "zoom_extents", "zoom_to_bounds"]
    }
  },

  "checkpoints": {
    "after_layers": {
      "description": "레이어 생성 후",
      "level": "L1",
      "checks": [
        {
          "type": "layer_exists",
          "tool": "get_dxf_layers",
          "validate": "required_layers가 모두 존재"
        }
      ]
    },
    "after_grid": {
      "description": "그리드 작성 후",
      "level": "L2",
      "checks": [
        {
          "type": "entity_count",
          "tool": "count_by_type",
          "layer": "A-GRID",
          "expected": {
            "LINE": {"min": 4},
            "CIRCLE": {"min": 4},
            "TEXT": {"min": 4}
          }
        },
        {
          "type": "bounds_check",
          "tool": "get_dxf_summary",
          "validate": "bounds가 예상 범위 내"
        }
      ]
    },
    "after_walls": {
      "description": "벽체 작성 후",
      "level": "L2",
      "checks": [
        {
          "type": "entity_count",
          "tool": "count_by_type",
          "layer": "A-WALL",
          "expected": {
            "LWPOLYLINE": {"min": 1}
          }
        }
      ]
    },
    "after_openings": {
      "description": "개구부 작성 후",
      "level": "L2",
      "checks": [
        {
          "type": "entity_count",
          "tool": "count_by_type",
          "layers": ["A-DOOR", "A-WINDOW"],
          "expected": {
            "LINE": {"min": 0},
            "ARC": {"min": 0}
          }
        }
      ]
    },
    "after_dimensions": {
      "description": "치수 배치 후",
      "level": "L2",
      "checks": [
        {
          "type": "entity_count",
          "tool": "count_by_type",
          "layer": "A-DIM",
          "expected": {
            "DIMENSION": {"min": 1}
          }
        }
      ]
    },
    "final": {
      "description": "최종 완료",
      "level": "L3",
      "checks": [
        {
          "type": "visual_confirmation",
          "tool": "capture_dxf_view",
          "validate": "시각적으로 의도한 형태 확인"
        },
        {
          "type": "summary_check",
          "tool": "get_dxf_summary",
          "validate": "전체 엔티티 수가 예상 범위 내"
        }
      ]
    }
  },

  "validation_logic": {
    "entity_count": {
      "description": "엔티티 개수 검증",
      "implementation": {
        "step1": "count_by_type 또는 get_dxf_summary 호출",
        "step2": "지정된 레이어의 엔티티 타입별 개수 추출",
        "step3": "expected.min 이상, expected.max 이하인지 확인",
        "step4": "실패 시 상세 정보 기록"
      },
      "example": {
        "check": {"layer": "A-GRID", "type": "LINE", "expected": {"min": 6}},
        "result": {"actual": 6, "pass": true}
      }
    },
    "bounds_check": {
      "description": "도면 범위 검증",
      "implementation": {
        "step1": "get_dxf_summary로 bounds 획득",
        "step2": "예상 범위와 비교 (tolerance 적용)",
        "step3": "pass/fail 판정"
      },
      "example": {
        "check": {"expected_width": 12000, "tolerance": 100},
        "result": {"actual_width": 12000, "pass": true}
      }
    },
    "layer_exists": {
      "description": "레이어 존재 검증",
      "implementation": {
        "step1": "get_dxf_layers로 레이어 목록 획득",
        "step2": "required_layers가 모두 포함되었는지 확인"
      }
    },
    "visual_confirmation": {
      "description": "시각적 검증",
      "implementation": {
        "step1": "zoom_extents로 전체 뷰 설정",
        "step2": "capture_dxf_view로 이미지 캡처",
        "step3": "이미지 분석하여 주요 요소 존재 확인"
      }
    }
  },

  "failure_actions": {
    "L1_failure": {
      "description": "tool 호출 실패",
      "actions": [
        "에러 메시지 분석",
        "args 형식 확인",
        "undo_last_action 시도 (필요시)",
        "수정된 args로 재시도",
        "3회 실패 시 사용자에게 보고"
      ]
    },
    "L2_failure": {
      "description": "통계 검증 실패",
      "actions": [
        "예상값과 실제값 비교 기록",
        "누락된 엔티티 식별",
        "L3 검증으로 상세 확인",
        "필요시 보완 작업 수행"
      ]
    },
    "L3_failure": {
      "description": "시각적 검증 실패",
      "actions": [
        "문제 영역 식별",
        "해당 영역 zoom_to_bounds로 확대 확인",
        "수정 작업 계획",
        "실패 내용 failures.json에 기록"
      ]
    }
  },

  "auto_recovery": {
    "entity_missing": {
      "condition": "expected보다 entity 수가 적음",
      "action": "누락된 entity 재생성"
    },
    "wrong_layer": {
      "condition": "entity가 잘못된 레이어에 생성됨",
      "action": "change_entity_layer로 이동 또는 삭제 후 재생성"
    },
    "position_error": {
      "condition": "entity 위치가 tolerance 밖",
      "action": "move_entities로 위치 보정 또는 삭제 후 재생성"
    }
  }
}
